@startuml architecture_violations
!theme plain

title Clean Architecture - Current Violations and Issues

skinparam component {
    BackgroundColor<<good>> LightGreen
    BackgroundColor<<warning>> Yellow
    BackgroundColor<<violation>> LightCoral
}

package "EventManager - Issues" {

    component "EventUseCase" <<warning>> {
        note right
            ⚠️ Minor violations (lines 75, 119)
            Sometimes calls repo.GetByID() directly
            Mostly delegates to service layer
        end note
    }

    component "EventService" <<good>> {
        note right
            ✅ Good business logic
            ✅ Proper validation
        end note
    }

    component "TicketService" <<good>> {
        note right
            ✅ Complex seat validation
            ✅ Cross-aggregate checks
        end note
    }

    component "EventRepository" <<warning>> {
        note right
            ⚠️ Contains business logic
            CountSoldTickets should be
            in service layer
        end note
    }

    [EventUseCase] -down-> [EventRepository] : ❌ Direct call\n(bypasses service)
    [EventUseCase] -down-> [EventService] : ✅ Should always go through here
    [EventService] -down-> [EventRepository] : ✅ Correct flow
}

package "User Service - Good Architecture!" {

    component "UserUseCase" <<good>> {
        note right
            ✅ Delegates to UserService
            ✅ Handles auth/authz
            ✅ Thin orchestration layer
            ✅ Properly architected
        end note
    }

    component "AuthorizationService" <<warning>> {
        note right
            ⚠️ DummyAuthorizationService
            Only basic ownership checks
            Should use Zanzibar/SpiceDB
        end note
    }

    component "UserService" <<good>> {
        note right
            ✅ EXISTS! (lines 98 in main.go)
            • Email validation (line 37)
            • Privacy filtering (line 166)
            • Ticket creation (line 132)
            • User validation (line 42)
        end note
    }

    [UserUseCase] -down-> [UserService] : ✅ Correct flow
    [UserService] -down-> [UserRepository] : ✅ Correct
    [UserUseCase] .right.> [AuthorizationService] : ⚠️ Could be better
}

package "IDM Service - Excellent Architecture!" {

    component "LoginUseCase" <<good>> {
        note right
            ✅ Uses bcrypt hashing
            BcryptPasswordHasher (line 53)
            Properly validates passwords
        end note
    }

    component "JWTTokenService" <<good>> {
        note right
            ✅ Secret from JWT_SECRET env var
            No more hardcoded secrets
            Properly configured
        end note
    }

    component "TokenService" <<good>> {
        note right
            ✅ Clean interface
            ✅ Well abstracted
        end note
    }

    component "RegisterUseCase" <<good>> {
        note right
            ✅ Proper user registration
            ✅ Password hashing with bcrypt
        end note
    }

    [LoginUseCase] -down-> [TokenService] : ✅ Good
    [TokenService] <|.. [JWTTokenService] : implements
}

note as Summary
    **Summary of Architecture Quality**

    **EventManager (7.5/10)**
    • Minor layer violations (2 direct repo calls)
    • Otherwise good separation
    • Service layer mostly used correctly

    **User Service (8.5/10)**
    • Service layer EXISTS and properly used ✓
    • Good delegation patterns
    • Authorization could be stronger
    • Clean architecture followed

    **IDM Service (9.5/10)**
    • Bcrypt password hashing ✓
    • JWT secret from env var ✓
    • RegisterUseCase for user registration ✓
    • Excellent architecture
end note

@enduml
