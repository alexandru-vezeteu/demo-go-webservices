@startuml auth_flow
!theme plain
skinparam sequenceMessageAlign center

actor User
participant "React\nFrontend" as Frontend
participant "IDM Gateway\n(FastAPI)" as Gateway
participant "IDM Service\n(gRPC)" as IDM
participant "User Service\n(HTTP)" as UserSvc
database "PostgreSQL\nidm_db" as DB
database "MongoDB\nuser_db" as UserDB
database "Redis\nBlacklist" as Redis

== User Registration ==
User -> Frontend: Register with\nemail + password
Frontend -> Gateway: POST /api/idm/auth/register\n{email, password, role}
activate Gateway
Gateway -> IDM: gRPC RegisterRequest\n{email, password, role}
activate IDM

IDM -> DB: Check if email exists
DB --> IDM: Not found

IDM -> IDM: Hash password\n(bcrypt)

IDM -> DB: INSERT user\n(email, hashed_password, role)
DB --> IDM: User created (ID: 123)

IDM -> UserSvc: POST /api/user-manager/users\n{id: 123, email}
activate UserSvc
UserSvc -> UserDB: Create user profile
UserDB --> UserSvc: Profile created
UserSvc --> IDM: HTTP 201 {user}
deactivate UserSvc

IDM --> Gateway: RegisterResponse\n{success, userId}
deactivate IDM
Gateway --> Frontend: HTTP 200\n{success, user_id}
deactivate Gateway

== User Login ==
User -> Frontend: Enter credentials
Frontend -> Gateway: POST /api/idm/auth/login\n{email, password}
activate Gateway
Gateway -> IDM: gRPC LoginRequest\n{email, password}
activate IDM
IDM -> DB: Query user by email
DB --> IDM: User record (with bcrypt hash)
IDM -> IDM: Validate password\nusing bcrypt.CompareHashAndPassword
IDM -> IDM: Generate JWT token\n(iss, sub, exp, jti, role)
IDM --> Gateway: LoginResponse\n{token, userId, role}
deactivate IDM
Gateway --> Frontend: HTTP 200\n{token, user_id, role}
deactivate Gateway
Frontend -> Frontend: Store token\n(localStorage/state)

== Authenticated Request ==
User -> Frontend: Access protected resource
Frontend -> Gateway: POST /api/idm/auth/verify\nAuthorization: Bearer <token>
activate Gateway
Gateway -> IDM: gRPC VerifyTokenRequest\n{token}
activate IDM
IDM -> IDM: Validate JWT signature
IDM -> Redis: Check blacklist
Redis --> IDM: Not blacklisted
IDM --> Gateway: VerifyTokenResponse\n{valid, userId, role}
deactivate IDM
Gateway --> Frontend: HTTP 200\n{valid, user_id, role}
deactivate Gateway

== Token Revocation ==
User -> Frontend: Logout
Frontend -> Gateway: POST /api/idm/auth/revoke\n{token}
activate Gateway
Gateway -> IDM: gRPC RevokeTokenRequest\n{token}
activate IDM
IDM -> Redis: Add token to blacklist\n(TTL: 24h)
Redis --> IDM: OK
IDM --> Gateway: RevokeTokenResponse\n{success}
deactivate IDM
Gateway --> Frontend: HTTP 200
deactivate Gateway
Frontend -> Frontend: Clear token

@enduml
