@startuml auth_flow
!theme plain
skinparam sequenceMessageAlign center

actor User
participant "React\nFrontend" as Frontend
participant "IDM Gateway\n(FastAPI)" as Gateway
participant "IDM Service\n(gRPC)" as IDM
database "PostgreSQL\nidm_db" as DB
database "Redis\nBlacklist" as Redis

== User Login ==
User -> Frontend: Enter credentials
Frontend -> Gateway: POST /api/idm/auth/login\n{email, password}
activate Gateway
Gateway -> IDM: gRPC LoginRequest\n{email, password}
activate IDM
IDM -> DB: Query user by email
DB --> IDM: User record
IDM -> IDM: Validate password
IDM -> IDM: Generate JWT token\n(iss, sub, exp, jti, role)
IDM --> Gateway: LoginResponse\n{token, userId, role}
deactivate IDM
Gateway --> Frontend: HTTP 200\n{token, user_id, role}
deactivate Gateway
Frontend -> Frontend: Store token\n(localStorage/state)

== Authenticated Request ==
User -> Frontend: Access protected resource
Frontend -> Gateway: POST /api/idm/auth/verify\nAuthorization: Bearer <token>
activate Gateway
Gateway -> IDM: gRPC VerifyTokenRequest\n{token}
activate IDM
IDM -> IDM: Validate JWT signature
IDM -> Redis: Check blacklist
Redis --> IDM: Not blacklisted
IDM --> Gateway: VerifyTokenResponse\n{valid, userId, role}
deactivate IDM
Gateway --> Frontend: HTTP 200\n{valid, user_id, role}
deactivate Gateway

== Token Revocation ==
User -> Frontend: Logout
Frontend -> Gateway: POST /api/idm/auth/revoke\n{token}
activate Gateway
Gateway -> IDM: gRPC RevokeTokenRequest\n{token}
activate IDM
IDM -> Redis: Add token to blacklist\n(TTL: 24h)
Redis --> IDM: OK
IDM --> Gateway: RevokeTokenResponse\n{success}
deactivate IDM
Gateway --> Frontend: HTTP 200
deactivate Gateway
Frontend -> Frontend: Clear token

@enduml
