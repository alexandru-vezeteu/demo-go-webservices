@startuml Delete_Event_Packet_Flow

skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2
skinparam sequenceParticipantBorderColor #2C3E50
skinparam sequenceLifeLineBorderColor #7F8C8D

title Delete Event Packet Flow

actor "Client" as client
participant "Frontend\n(React)" as frontend
participant "EventManager\n(HTTP)" as eventMgr
participant "IDM Service\n(gRPC)" as idm
database "PostgreSQL\n(Events)" as eventDB

client -> frontend: Delete event packet (click delete)
frontend -> eventMgr: DELETE /api/event-manager/event-packets/:id\nHeader: Authorization: Bearer <token>

eventMgr -> eventMgr: Extract token from header
alt No Authorization header
    eventMgr --> frontend: 401 Unauthorized\n"Authorization header required"
    frontend --> client: Show error
end

eventMgr -> idm: gRPC WhoIsUser(token)
alt Invalid/expired token
    idm --> eventMgr: Error
    eventMgr --> frontend: 422 Unprocessable Entity\n"invalid or expired token"
    frontend --> client: Show login required
end
idm --> eventMgr: UserIdentity (id, role)

eventMgr -> eventDB: SELECT event_packet WHERE id = :id
alt Packet not found
    eventDB --> eventMgr: Not found
    eventMgr --> frontend: 404 Not Found
    frontend --> client: Show "Packet not found"
end
eventDB --> eventMgr: EventPacket data

eventMgr -> eventMgr: CanUserDeleteEventPacket(identity, packet)
note right of eventMgr
  Authorization check:
  - User must be owner of packet
  - OR user has admin role
end note

alt Not authorized
    eventMgr --> frontend: 403 Forbidden\n"you don't have permission to delete this event packet"
    frontend --> client: Show "Access denied"
end

eventMgr -> eventDB: DELETE FROM event_packets WHERE id = :id
note right of eventDB
  CASCADE: Also deletes
  - Related event_packet_inclusions
  - Related tickets referencing this packet
end note
eventDB --> eventMgr: Deleted packet data

eventMgr --> frontend: 200 OK\n{deleted packet with HATEOAS links}
frontend --> client: Show "Packet deleted!" + redirect

@enduml
