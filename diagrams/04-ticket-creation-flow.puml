@startuml ticket_creation_flow
!theme plain

actor User
participant "React\nFrontend" as Frontend
participant "User Service\n:12346" as UserSvc
participant "IDM Service\n:50051" as IDM
participant "EventManager\n:8080" as EventMgr
database "MongoDB\nuser_db" as MongoDB
database "PostgreSQL\nevent_db" as PostgresDB

== Service Authentication ==
UserSvc -> UserSvc: ServiceAuthClient\ncaches token with 5min buffer
UserSvc -> IDM: gRPC Login\n{serviciu_clienti account}
activate IDM
IDM --> UserSvc: Service token
deactivate IDM
UserSvc -> UserSvc: Cache with RWMutex protection

== User Creates Ticket ==
User -> Frontend: Create ticket for user
Frontend -> UserSvc: POST /clients/{user_id}/tickets\nAuthorization: Bearer <user_token>\n{event_id, packet_id}
activate UserSvc

UserSvc -> IDM: gRPC VerifyToken\n{user_token}
activate IDM
IDM --> UserSvc: Valid user
deactivate IDM

UserSvc -> UserSvc: Generate ticket code\n(UUID)

UserSvc -> EventMgr: PUT /tickets/{code}\nAuthorization: Bearer <service_token>\n{event_id, packet_id}
activate EventMgr

EventMgr -> IDM: gRPC VerifyToken\n{service_token}
activate IDM
IDM --> EventMgr: Valid service account
deactivate IDM

EventMgr -> PostgresDB: INSERT INTO tickets\n(code, event_id, packet_id)
PostgresDB --> EventMgr: Ticket created

EventMgr --> UserSvc: HTTP 201\n{ticket with HATEOAS links}
deactivate EventMgr

UserSvc -> MongoDB: Update user.ticket_list\nPUSH ticket reference
MongoDB --> UserSvc: Updated

UserSvc --> Frontend: HTTP 201\n{ticket details}
deactivate UserSvc

Frontend --> User: Ticket created successfully

@enduml
