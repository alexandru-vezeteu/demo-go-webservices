@startuml ideal_vs_current
!theme plain

title Ideal Clean Architecture vs Current Implementation

skinparam component {
    BackgroundColor<<ideal>> LightGreen
    BackgroundColor<<current>> Yellow
    BackgroundColor<<missing>> LightCoral
}

package "IDEAL - EventManager" {
    [Handler] as IEH <<ideal>>
    [UseCase] as IEUC <<ideal>>
    [Service] as IES <<ideal>>
    [Repository] as IER <<ideal>>
    [Domain] as IED <<ideal>>

    IEH --> IEUC : orchestrates
    IEUC --> IES : delegates business logic
    IES --> IER : persists
    IES --> IED : uses
    IER --> IED : uses

    note right of IEUC
        ✅ UseCase only:
        • Authenticates
        • Authorizes
        • Calls service
        • Returns result
    end note

    note right of IES
        ✅ Service contains:
        • ALL validation
        • Business rules
        • Cross-aggregate logic
        • State transitions
    end note
}

package "CURRENT - EventManager" {
    [Handler] as CEH <<current>>
    [UseCase] as CEUC <<current>>
    [Service] as CES <<current>>
    [Repository] as CER <<current>>
    [Domain] as CED <<current>>

    CEH --> CEUC
    CEUC --> CES : sometimes
    CEUC --> CER : ❌ direct calls
    CES --> CER
    CES --> CED
    CER --> CED
    CEUC --> CED

    note right of CEUC
        ⚠️ UseCase does:
        • Authentication ✅
        • Authorization ✅
        • Sometimes calls service ✅
        • Sometimes bypasses service ❌
        • Direct repo.Create() ❌
        • Duplicate validation ❌
    end note

    note right of CES
        ⚠️ Service has:
        • Good validation ✅
        • Business rules ✅
        • But UseCase bypasses it ❌
    end note
}

package "IDEAL - User Service" {
    [Handler] as IUH <<ideal>>
    [UseCase] as IUUC <<ideal>>
    [UserService] as IUS <<ideal>>
    [Repository] as IUR <<ideal>>
    [Domain] as IUD <<ideal>>
    [AuthZ] as IUAZ <<ideal>>

    IUH --> IUUC
    IUUC --> IUS : delegates
    IUUC --> IUAZ : checks permissions
    IUS --> IUR
    IUS --> IUD
    IUR --> IUD

    note right of IUUC
        ✅ UseCase only:
        • Authenticates
        • Checks AuthZ service
        • Calls UserService
        • Coordinates ext. services
    end note

    note right of IUS
        ✅ Service contains:
        • Email validation
        • Privacy filtering
        • Business logic
    end note
}

package "CURRENT - User Service (MATCHES IDEAL!)" {
    [Handler] as CUH <<ideal>>
    [UseCase] as CUUC <<ideal>>
    [UserService] as CUS <<ideal>>
    [Repository] as CUR <<ideal>>
    [Domain] as CUD <<ideal>>
    [AuthZ] as CUAZ <<current>>

    CUH --> CUUC
    CUUC --> CUS : ✅ correct
    CUS --> CUR : ✅ correct
    CUS --> CUD
    CUR --> CUD
    CUUC .> CUAZ : ⚠️ could be better

    note right of CUUC
        ✅ UseCase does:
        • Authentication ✅
        • Authorization ✅
        • Delegates to service ✅
        • Thin orchestration ✅
        • Properly architected!
    end note

    note right of CUS
        ✅ EXISTS! UserService.go
        • Email validation ✅
        • Privacy filtering ✅
        • Ticket creation ✅
        • User validation ✅
    end note

    note right of CUAZ
        ⚠️ Exists:
        • DummyAuthorizationService
        • Basic but functional
    end note
}

package "IDM Service - Excellent!" {
    [gRPC Server] as IGS <<ideal>>
    [RegisterUseCase] as IRUC <<ideal>>
    [LoginUseCase] as ILUC <<ideal>>
    [VerifyUseCase] as IVUC <<ideal>>
    [TokenService] as ITS <<ideal>>
    [PasswordHasher] as IPH <<ideal>>
    [Repository] as IR <<ideal>>
    [Domain] as IDO <<ideal>>

    IGS --> IRUC
    IGS --> ILUC
    IGS --> IVUC
    IRUC --> IR
    IRUC --> IPH
    ILUC --> ITS
    ILUC --> IR
    ILUC --> IPH
    IVUC --> ITS
    IR --> IDO
    ITS --> IDO

    note right of ILUC
        ✅ Thin use case:
        • Find user
        • Generate token
        • Return result
        ✅ No issues!
    end note

    note right of ITS
        ✅ Clean interface:
        • Well abstracted
        • Single responsibility
        ✅ JWT secret from env var
    end note
}

note as ComparisonSummary
    **Key Differences & Recommendations**

    **EventManager:**
    Current: 7.5/10 → Target: 9/10
    • Fix 2 direct UseCase → Repository calls (lines 75, 119)
    • Otherwise properly architected
    • Service layer exists and mostly used

    **User Service:**
    Current: 8.5/10 → Target: 9/10
    • UserService layer EXISTS and properly used! ✓
    • Good delegation patterns ✓
    • Strengthen AuthZ (replace Dummy with real)
    • Already follows clean architecture!

    **IDM Service:**
    Current: 9.5/10 → Target: 10/10
    • Bcrypt password hashing ✓
    • JWT secret from env var ✓
    • RegisterUseCase for registration ✓
    • Add refresh token support
    • Excellent architecture!

    **Overall System:**
    • Clean architecture mostly followed ✓
    • User Service architecture is exemplary
    • Minor fixes needed in EventManager
    • Good separation of concerns
end note

@enduml
