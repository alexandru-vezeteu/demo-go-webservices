syntax = "proto3";

package idm;

option go_package = "idmService/proto";

service IdentityService {
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc VerifyToken(VerifyTokenRequest) returns (VerifyTokenResponse);
  rpc RevokeToken(RevokeTokenRequest) returns (RevokeTokenResponse);

  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
  rpc WriteRelationships(WriteRelationshipsRequest) returns (WriteRelationshipsResponse);
  rpc ReadRelationships(ReadRelationshipsRequest) returns (ReadRelationshipsResponse);
}

message LoginRequest {
  string email = 1;    // User email address
  string password = 2; // User password
}

message LoginResponse {
  bool success = 1;
  string token = 2;  // JWT token in Base64Url format with claims: iss, sub, exp, jti, role
  string message = 3;
  string user_id = 4;  // User ID (corresponds to 'sub' claim in JWT)
  string role = 5;     // User role (corresponds to 'role' claim in JWT)
  string email = 6;    // User email address
}

message VerifyTokenRequest {
  string token = 1;  // JWT token to verify
}

message VerifyTokenResponse {
  bool valid = 1;      // false if expired or blacklisted, true if valid
  string email = 2;    // User email address
  string message = 3;  // Contains reason if invalid (expired, blacklisted, corrupted)
  string user_id = 4;  // User ID extracted from token's 'sub' claim (clear text)
  string role = 5;     // Role extracted from token's 'role' claim (clear text)
  string issuer = 6;   // Issuer extracted from token's 'iss' claim
  int64 expires_at = 7; // Expiration timestamp from token's 'exp' claim
  bool expired = 8;    // true if token has expired
  bool blacklisted = 9; // true if token is in blacklist
}

message RevokeTokenRequest {
  string token = 1;  // JWT token to revoke/destroy
}

message RevokeTokenResponse {
  bool success = 1;  // Always true (validation processing completed successfully)
  string message = 2; // Success message or reason for revocation
}

message ObjectReference {
  string object_type = 1;
  string object_id = 2;
}

message SubjectReference {
  string subject_type = 1;
  string subject_id = 2;
  optional string relation = 3;
}

message RelationshipTuple {
  ObjectReference resource = 1;
  string relation = 2;
  SubjectReference subject = 3;
}

message CheckPermissionRequest {
  ObjectReference resource = 1;
  string permission = 2;
  SubjectReference subject = 3;
}

message CheckPermissionResponse {
  bool permitted = 1;
  string message = 2;
}

enum RelationshipUpdateOperation {
  OPERATION_UNSPECIFIED = 0;
  OPERATION_CREATE = 1;
  OPERATION_DELETE = 2;
}

message RelationshipUpdate {
  RelationshipUpdateOperation operation = 1;
  RelationshipTuple relationship = 2;
}

message WriteRelationshipsRequest {
  repeated RelationshipUpdate updates = 1;
}

message WriteRelationshipsResponse {
  bool success = 1;
  string message = 2;
  int32 relationships_written = 3;
}

message RelationshipFilter {
  optional ObjectReference resource_filter = 1;
  optional string relation_filter = 2;
  optional SubjectReference subject_filter = 3;
}

message ReadRelationshipsRequest {
  RelationshipFilter filter = 1;
  optional int32 limit = 2;
}

message ReadRelationshipsResponse {
  repeated RelationshipTuple relationships = 1;
  int32 total_count = 2;
}
